<!--pages/tools/audio-format/index.wxml-->
<wxs module="utils">
  var calcSavings = function(original, converted) {
    if (original === 0) return 0;
    return ((1 - converted / original) * 100).toFixed(1);
  };

  module.exports = {
    calcSavings: calcSavings
  };
</wxs>

<view class="container">

  <!-- æ–‡ä»¶é€‰æ‹©åŒº -->
  <view class="upload-section">
    <view class="upload-box" bindtap="chooseAudios">
      <text class="upload-icon">ğŸµ</text>
      <text class="upload-text">é€‰æ‹©éŸ³é¢‘</text>
      <text class="upload-hint">æ”¯æŒMP3ã€AACã€WAVæ ¼å¼ï¼Œå•ä¸ªä¸è¶…è¿‡50MB</text>
    </view>
  </view>

  <!-- éŸ³é¢‘åˆ—è¡¨ -->
  <view class="audios-section" wx:if="{{audios.length > 0}}">
    <view class="section-header">
      <text class="section-title">éŸ³é¢‘åˆ—è¡¨ ({{audios.length}})</text>
      <text class="clear-btn" bindtap="clearAll">æ¸…ç©º</text>
    </view>

    <view class="audio-list">
      <view class="audio-item" wx:for="{{audios}}" wx:key="index">
        <view class="audio-preview">
          <text class="audio-icon">ğŸ§</text>
          <text class="audio-badge">{{item.durationText}}</text>
        </view>

        <view class="audio-info">
          <view class="info-row">
            <text class="info-label">åŸå§‹:</text>
            <text class="info-value">{{formatSize(item.originalSize)}} | {{item.format}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedFileID}}">
            <text class="info-label success">è½¬æ¢å:</text>
            <text class="info-value">{{formatSize(item.convertedSize)}} | {{item.targetFormat}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedFileID && item.originalSize > item.convertedSize}}">
            <text class="savings">ğŸ’¾ èŠ‚çœ {{utils.calcSavings(item.originalSize, item.convertedSize)}}%</text>
          </view>
        </view>

        <view class="audio-actions">
          <button class="action-btn save-btn" wx:if="{{item.convertedFileID}}"
                  bindtap="saveSingleAudio" data-index="{{index}}">
            ä¿å­˜
          </button>
          <button class="action-btn delete-btn" bindtap="deleteAudio" data-index="{{index}}">
            åˆ é™¤
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- è½¬æ¢è®¾ç½® -->
  <view class="settings-section" wx:if="{{audios.length > 0}}">
    <view class="section-title">è½¬æ¢è®¾ç½®</view>

    <!-- ç›®æ ‡æ ¼å¼ -->
    <view class="setting-item">
      <text class="setting-label">ç›®æ ‡æ ¼å¼</text>
      <picker class="setting-picker" mode="selector"
              range="{{formatOptions}}" range-key="label"
              value="{{targetFormatIndex}}"
              bindchange="onFormatChange">
        <view class="picker-display">
          <text>{{formatOptions[targetFormatIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- è´¨é‡é¢„è®¾ -->
    <view class="setting-item">
      <text class="setting-label">éŸ³è´¨</text>
      <view class="quality-presets">
        <view class="preset-btn {{qualityPreset === item.value ? 'active' : ''}}"
              wx:for="{{qualityOptions}}" wx:key="value"
              bindtap="selectQualityPreset" data-quality="{{item.value}}">
          {{item.label}}
        </view>
      </view>
    </view>

    <!-- æ¯”ç‰¹ç‡ -->
    <view class="setting-item">
      <text class="setting-label">æ¯”ç‰¹ç‡</text>
      <picker class="setting-picker" mode="selector"
              range="{{bitrateOptions}}" range-key="label"
              value="{{bitrateIndex}}"
              bindchange="onBitrateChange">
        <view class="picker-display">
          <text>{{bitrateOptions[bitrateIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- è½¬æ¢æŒ‰é’® -->
  <view class="action-section" wx:if="{{audios.length > 0}}">
    <button class="convert-btn"
            bindtap="startConvert"
            disabled="{{isConverting}}"
            loading="{{isConverting}}">
      {{isConverting ? 'è½¬æ¢ä¸­ ' + convertProgress + '%' : 'å¼€å§‹è½¬æ¢'}}
    </button>

    <!-- è½¬æ¢ç»Ÿè®¡ -->
    <view class="stats" wx:if="{{totalConvertedSize > 0}}">
      <view class="stat-item">
        <text class="stat-label">åŸå§‹å¤§å°:</text>
        <text class="stat-value">{{formatSize(totalOriginalSize)}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">è½¬æ¢å:</text>
        <text class="stat-value">{{formatSize(totalConvertedSize)}}</text>
      </view>
      <view class="stat-item" wx:if="{{savingsPercent > 0}}">
        <text class="stat-label">èŠ‚çœç©ºé—´:</text>
        <text class="stat-value success">{{savingsPercent}}%</text>
      </view>
    </view>

    <!-- ä¿å­˜å…¨éƒ¨æŒ‰é’® -->
    <button class="save-all-btn"
            wx:if="{{totalConvertedSize > 0}}"
            bindtap="saveAllToLocal">
      ğŸ’¾ ä¿å­˜å…¨éƒ¨åˆ°æœ¬åœ°
    </button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{audios.length === 0}}">
    <text class="empty-icon">ğŸ¼</text>
    <text class="empty-text">è¿˜æ²¡æœ‰éŸ³é¢‘</text>
    <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©éŸ³é¢‘å¼€å§‹è½¬æ¢</text>
  </view>

</view>

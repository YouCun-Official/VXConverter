<!--pages/tools/pdf-merge/index.wxml-->
<wxs module="utils">
  var formatSize = function(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024;
    var sizes = ['B', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
  };

  module.exports = {
    formatSize: formatSize
  };
</wxs>

<view class="container">

  <!-- 选择文件区 -->
  <view class="upload-section">
    <view class="upload-box" bindtap="choosePDF">
      <text class="upload-icon">📄</text>
      <text class="upload-text">选择PDF文件</text>
      <text class="upload-hint">点击选择多个PDF文件进行合并</text>
      <text class="upload-hint">最多10个，单个文件不超过50MB</text>
    </view>
  </view>

  <!-- PDF文件列表 -->
  <view class="files-section" wx:if="{{pdfFiles.length > 0}}">
    <view class="section-header">
      <text class="section-title">PDF列表 ({{pdfFiles.length}}个)</text>
      <text class="clear-btn" bindtap="clearAll">清空</text>
    </view>

    <view class="tips-box">
      <text class="tips-icon">💡</text>
      <text class="tips-text">长按拖动卡片可调整合并顺序</text>
    </view>

    <view class="pdf-list">
      <view class="pdf-card {{isDragging && dragIndex === index ? 'dragging' : ''}}"
            wx:for="{{pdfFiles}}" wx:key="id"
            bindlongpress="onLongPress"
            bindtouchmove="onTouchMove"
            bindtouchend="onTouchEnd"
            data-index="{{index}}">

        <!-- 序号 -->
        <view class="pdf-index">{{index + 1}}</view>

        <!-- PDF信息 -->
        <view class="pdf-info">
          <view class="pdf-name">
            <text class="pdf-icon">📄</text>
            <text class="pdf-name-text">{{item.name}}</text>
          </view>
          <view class="pdf-meta">
            <text class="pdf-size">{{utils.formatSize(item.size)}}</text>
          </view>
        </view>

        <!-- 操作按钮 -->
        <view class="pdf-actions">
          <view class="action-btn move-btn"
                wx:if="{{index > 0}}"
                bindtap="moveUp"
                data-index="{{index}}"
                catchtap="moveUp">
            <text class="action-icon">↑</text>
          </view>
          <view class="action-btn move-btn"
                wx:if="{{index < pdfFiles.length - 1}}"
                bindtap="moveDown"
                data-index="{{index}}"
                catchtap="moveDown">
            <text class="action-icon">↓</text>
          </view>
          <view class="action-btn delete-btn"
                bindtap="deletePDF"
                data-index="{{index}}"
                catchtap="deletePDF">
            <text class="action-icon">✕</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 合并按钮 -->
    <view class="merge-section">
      <button class="merge-btn"
              bindtap="startMerge"
              disabled="{{isMerging || pdfFiles.length < 2}}"
              loading="{{isMerging}}">
        {{isMerging ? '合并中 ' + mergeProgress + '%' : '开始合并'}}
      </button>

      <view class="merge-tips" wx:if="{{pdfFiles.length < 2}}">
        <text>至少需要2个PDF文件才能合并</text>
      </view>
    </view>

    <!-- 合并结果 -->
    <view class="result-section" wx:if="{{mergedFileID}}">
      <view class="result-card">
        <view class="result-header">
          <text class="result-icon">✅</text>
          <text class="result-title">合并完成</text>
        </view>

        <view class="result-info">
          <text class="result-text">已合并 {{pdfFiles.length}} 个PDF文件</text>
        </view>

        <view class="result-actions">
          <button class="result-btn download-btn" bindtap="downloadMerged">
            📥 打开文件
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{pdfFiles.length === 0}}">
    <text class="empty-icon">📑</text>
    <text class="empty-text">还没有PDF文件</text>
    <text class="empty-hint">点击上方按钮选择PDF文件</text>
    <text class="empty-hint">可以一次选择多个文件</text>
  </view>

  <!-- 使用说明 -->
  <view class="guide-section" wx:if="{{pdfFiles.length === 0}}">
    <view class="guide-title">📖 使用说明</view>
    <view class="guide-item">
      <text class="guide-step">1.</text>
      <text class="guide-text">点击"选择PDF文件"添加多个PDF</text>
    </view>
    <view class="guide-item">
      <text class="guide-step">2.</text>
      <text class="guide-text">长按卡片拖动调整合并顺序</text>
    </view>
    <view class="guide-item">
      <text class="guide-step">3.</text>
      <text class="guide-text">或使用上下箭头调整顺序</text>
    </view>
    <view class="guide-item">
      <text class="guide-step">4.</text>
      <text class="guide-text">点击"开始合并"生成新PDF</text>
    </view>
    <view class="guide-item">
      <text class="guide-step">5.</text>
      <text class="guide-text">合并完成后可打开或分享</text>
    </view>
  </view>

</view>

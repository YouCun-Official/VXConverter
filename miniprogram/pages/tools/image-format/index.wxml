<!--pages/tools/image-format/index.wxml-->
<wxs module="utils">
  // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
  var formatPercent = function(value) {
    return value.toFixed(1);
  };

  // è®¡ç®—èŠ‚çœç™¾åˆ†æ¯”
  var calcSavings = function(original, converted) {
    if (original === 0) return 0;
    return ((1 - converted / original) * 100).toFixed(1);
  };

  module.exports = {
    formatPercent: formatPercent,
    calcSavings: calcSavings
  };
</wxs>

<view class="container">

  <!-- æ–‡ä»¶é€‰æ‹©åŒº -->
  <view class="upload-section">
    <view class="upload-box" bindtap="chooseImages">
      <text class="upload-icon">ğŸ“</text>
      <text class="upload-text">é€‰æ‹©å›¾ç‰‡</text>
      <text class="upload-hint">æ”¯æŒJPGã€PNGã€WEBPæ ¼å¼</text>
    </view>
  </view>

  <!-- å›¾ç‰‡åˆ—è¡¨ -->
  <view class="images-section" wx:if="{{images.length > 0}}">
    <view class="section-header">
      <text class="section-title">å›¾ç‰‡åˆ—è¡¨ ({{images.length}})</text>
      <text class="clear-btn" bindtap="clearAll">æ¸…ç©º</text>
    </view>

    <view class="image-list">
      <view class="image-item" wx:for="{{images}}" wx:key="index">
        <image class="image-preview" src="{{item.path}}" mode="aspectFill"></image>

        <view class="image-info">
          <view class="info-row">
            <text class="info-label">åŸå§‹:</text>
            <text class="info-value">{{formatSize(item.originalSize)}} | {{item.width}}x{{item.height}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedPath}}">
            <text class="info-label success">è½¬æ¢å:</text>
            <text class="info-value">{{formatSize(item.convertedSize)}} | {{item.format}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedPath && item.originalSize > item.convertedSize}}">
            <text class="savings">ğŸ’¾ èŠ‚çœ {{utils.calcSavings(item.originalSize, item.convertedSize)}}%</text>
          </view>
        </view>

        <view class="image-actions">
          <button class="action-btn save-btn" wx:if="{{item.convertedPath}}"
                  bindtap="saveSingleImage" data-index="{{index}}">
            ä¿å­˜
          </button>
          <button class="action-btn delete-btn" bindtap="deleteImage" data-index="{{index}}">
            åˆ é™¤
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- è½¬æ¢è®¾ç½® -->
  <view class="settings-section" wx:if="{{images.length > 0}}">
    <view class="section-title">è½¬æ¢è®¾ç½®</view>

    <!-- ç›®æ ‡æ ¼å¼ -->
    <view class="setting-item">
      <text class="setting-label">ç›®æ ‡æ ¼å¼</text>
      <picker class="setting-picker" mode="selector"
              range="{{formatOptions}}" range-key="label"
              bindchange="onFormatChange">
        <view class="picker-display">
          <text>{{formatOptions[0].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- è´¨é‡é¢„è®¾ -->
    <view class="setting-item">
      <text class="setting-label">è´¨é‡</text>
      <view class="quality-presets">
        <view class="preset-btn {{quality === item.value ? 'active' : ''}}"
              wx:for="{{qualityPresets}}" wx:key="value"
              bindtap="selectQualityPreset" data-quality="{{item.value}}">
          {{item.label}}
        </view>
      </view>
    </view>

    <!-- è´¨é‡æ»‘å— -->
    <view class="setting-item">
      <text class="setting-label">è‡ªå®šä¹‰è´¨é‡: {{qualityPercent}}%</text>
      <slider class="quality-slider"
              min="10" max="100"
              value="{{quality * 100}}"
              bindchange="onQualityChange"
              activeColor="#16a34a"
              backgroundColor="#e5e7eb"
              block-size="20"/>
    </view>

    <!-- å°ºå¯¸è°ƒæ•´ -->
    <view class="setting-item">
      <text class="setting-label">å°ºå¯¸</text>
      <picker class="setting-picker" mode="selector"
              range="{{resizeOptions}}" range-key="label"
              value="{{resizeIndex}}"
              bindchange="onResizeChange">
        <view class="picker-display">
          <text>{{resizeOptions[resizeIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- è½¬æ¢æŒ‰é’® -->
  <view class="action-section" wx:if="{{images.length > 0}}">
    <button class="convert-btn"
            bindtap="startConvert"
            disabled="{{isConverting}}"
            loading="{{isConverting}}">
      {{isConverting ? 'è½¬æ¢ä¸­ ' + convertProgress + '%' : 'å¼€å§‹è½¬æ¢'}}
    </button>

    <!-- è½¬æ¢ç»Ÿè®¡ -->
    <view class="stats" wx:if="{{totalConvertedSize > 0}}">
      <view class="stat-item">
        <text class="stat-label">åŸå§‹å¤§å°:</text>
        <text class="stat-value">{{formatSize(totalOriginalSize)}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">è½¬æ¢å:</text>
        <text class="stat-value">{{formatSize(totalConvertedSize)}}</text>
      </view>
      <view class="stat-item" wx:if="{{savingsPercent > 0}}">
        <text class="stat-label">èŠ‚çœç©ºé—´:</text>
        <text class="stat-value success">{{savingsPercent}}%</text>
      </view>
    </view>

    <!-- ä¿å­˜å…¨éƒ¨æŒ‰é’® -->
    <button class="save-all-btn"
            wx:if="{{totalConvertedSize > 0}}"
            bindtap="saveAllToAlbum">
      ğŸ’¾ ä¿å­˜å…¨éƒ¨åˆ°ç›¸å†Œ
    </button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{images.length === 0}}">
    <text class="empty-icon">ğŸ–¼ï¸</text>
    <text class="empty-text">è¿˜æ²¡æœ‰å›¾ç‰‡</text>
    <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©å›¾ç‰‡å¼€å§‹è½¬æ¢</text>
  </view>

</view>

<!--pages/tools/video-format/index.wxml-->
<wxs module="utils">
  var calcSavings = function(original, converted) {
    if (original === 0) return 0;
    return ((1 - converted / original) * 100).toFixed(1);
  };

  module.exports = {
    calcSavings: calcSavings
  };
</wxs>

<view class="container">

  <!-- æ–‡ä»¶é€‰æ‹©åŒº -->
  <view class="upload-section">
    <view class="upload-box" bindtap="chooseVideos">
      <text class="upload-icon">ğŸ¬</text>
      <text class="upload-text">é€‰æ‹©è§†é¢‘</text>
      <text class="upload-hint">æ”¯æŒMP4ã€MOVã€AVIï¼Œå•ä¸ªä¸è¶…è¿‡100MB</text>
    </view>
  </view>

  <!-- è§†é¢‘åˆ—è¡¨ -->
  <view class="videos-section" wx:if="{{videos.length > 0}}">
    <view class="section-header">
      <text class="section-title">è§†é¢‘åˆ—è¡¨ ({{videos.length}})</text>
      <text class="clear-btn" bindtap="clearAll">æ¸…ç©º</text>
    </view>

    <view class="video-list">
      <view class="video-item" wx:for="{{videos}}" wx:key="index">
        <view class="video-preview">
          <text class="video-icon">ğŸ¬</text>
          <text class="video-badge">{{item.durationText}}</text>
        </view>

        <view class="video-info">
          <view class="info-row">
            <text class="info-label">åŸå§‹:</text>
            <text class="info-value">{{formatSize(item.originalSize)}} | {{item.format}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedFileID}}">
            <text class="info-label success">è½¬æ¢å:</text>
            <text class="info-value">{{formatSize(item.convertedSize)}} | {{item.targetFormat}}</text>
          </view>

          <view class="info-row" wx:if="{{item.convertedFileID && item.originalSize > item.convertedSize}}">
            <text class="savings">ğŸ’¾ èŠ‚çœ {{utils.calcSavings(item.originalSize, item.convertedSize)}}%</text>
          </view>
        </view>

        <view class="video-actions">
          <button class="action-btn save-btn" wx:if="{{item.convertedFileID}}"
                  bindtap="saveSingleVideo" data-index="{{index}}">
            ä¿å­˜
          </button>
          <button class="action-btn delete-btn" bindtap="deleteVideo" data-index="{{index}}">
            åˆ é™¤
          </button>
        </view>
      </view>
    </view>
  </view>

  <view class="settings-section" wx:if="{{videos.length > 0}}">
    <view class="section-title">è½¬æ¢è®¾ç½®</view>

    <view class="setting-item">
      <text class="setting-label">ç›®æ ‡æ ¼å¼</text>
      <picker class="setting-picker" mode="selector"
              range="{{formatOptions}}" range-key="label"
              value="{{targetFormatIndex}}"
              bindchange="onFormatChange">
        <view class="picker-display">
          <text>{{formatOptions[targetFormatIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <view class="setting-item">
      <text class="setting-label">æ¸…æ™°åº¦é¢„è®¾</text>
      <view class="quality-presets">
        <view class="preset-btn {{qualityPreset === item.value ? 'active' : ''}}"
              wx:for="{{qualityOptions}}" wx:key="value"
              bindtap="selectQualityPreset" data-quality="{{item.value}}">
          {{item.label}}
        </view>
      </view>
    </view>

    <view class="setting-item">
      <text class="setting-label">åˆ†è¾¨ç‡</text>
      <picker class="setting-picker" mode="selector"
              range="{{resolutionOptions}}" range-key="label"
              value="{{resolutionIndex}}"
              bindchange="onResolutionChange">
        <view class="picker-display">
          <text>{{resolutionOptions[resolutionIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <view class="action-section" wx:if="{{videos.length > 0}}">
    <button class="convert-btn"
            bindtap="startConvert"
            disabled="{{isConverting}}"
            loading="{{isConverting}}">
      {{isConverting ? 'è½¬æ¢ä¸­ ' + convertProgress + '%' : 'å¼€å§‹è½¬æ¢'}}
    </button>

    <view class="stats" wx:if="{{totalConvertedSize > 0}}">
      <view class="stat-item">
        <text class="stat-label">åŸå§‹å¤§å°:</text>
        <text class="stat-value">{{formatSize(totalOriginalSize)}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">è½¬æ¢å:</text>
        <text class="stat-value">{{formatSize(totalConvertedSize)}}</text>
      </view>
      <view class="stat-item" wx:if="{{savingsPercent > 0}}">
        <text class="stat-label">èŠ‚çœç©ºé—´:</text>
        <text class="stat-value success">{{savingsPercent}}%</text>
      </view>
    </view>

    <button class="save-all-btn"
            wx:if="{{totalConvertedSize > 0}}"
            bindtap="saveAllToAlbum">
      ğŸ’¾ ä¿å­˜å…¨éƒ¨åˆ°ç›¸å†Œ
    </button>
  </view>

  <view class="empty-state" wx:if="{{videos.length === 0}}">
    <text class="empty-icon">ğŸï¸</text>
    <text class="empty-text">è¿˜æ²¡æœ‰è§†é¢‘</text>
    <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©è§†é¢‘å¼€å§‹è½¬æ¢</text>
  </view>

</view>

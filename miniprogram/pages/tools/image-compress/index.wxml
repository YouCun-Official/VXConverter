<!--pages/tools/image-compress/index.wxml-->
<wxs module="utils">
var formatPercent = function(value) {
  return Math.round(value * 100);
};
module.exports = {
  formatPercent: formatPercent
};
</wxs>

<view class="container">

  <!-- é¡¶éƒ¨æ“ä½œåŒº -->
  <view class="action-section">
    <button class="choose-btn" bindtap="chooseImages">
      <text class="icon">ğŸ“</text>
      <text>é€‰æ‹©å›¾ç‰‡</text>
    </button>
    <text class="image-count">å·²é€‰æ‹© {{images.length}} å¼ </text>
  </view>

  <!-- å‹ç¼©è®¾ç½® -->
  <view class="settings-section">
    <view class="section-title">ğŸšï¸ å‹ç¼©è®¾ç½®</view>

    <!-- è´¨é‡æ»‘å— -->
    <view class="setting-item">
      <view class="setting-label">
        <text>å‹ç¼©è´¨é‡</text>
        <text class="value">{{utils.formatPercent(quality)}}%</text>
      </view>
      <slider
        value="{{quality}}"
        min="0.1"
        max="1"
        step="0.05"
        activeColor="#16a34a"
        backgroundColor="#e5e5e5"
        block-size="20"
        bindchange="onQualityChange"
      />

      <!-- è´¨é‡é¢„è®¾æŒ‰é’® -->
      <view class="preset-buttons">
        <block wx:for="{{qualityPresets}}" wx:key="value">
          <button
            size="mini"
            class="preset-btn {{quality === item.value ? 'active' : ''}}"
            data-quality="{{item.value}}"
            bindtap="selectQualityPreset"
          >
            <text>{{item.icon}} {{item.label}}</text>
          </button>
        </block>
      </view>
    </view>

    <!-- å°ºå¯¸é€‰é¡¹ -->
    <view class="setting-item">
      <view class="setting-label">
        <text>å°ºå¯¸è°ƒæ•´</text>
      </view>
      <picker
        mode="selector"
        range="{{resizeOptions}}"
        range-key="label"
        value="{{resizeIndex}}"
        bindchange="onResizeChange"
      >
        <view class="picker">
          <text>{{resizeOptions[resizeIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- æ ¼å¼é€‰é¡¹ -->
    <view class="setting-item">
      <view class="setting-label">
        <text>è¾“å‡ºæ ¼å¼</text>
      </view>
      <picker
        mode="selector"
        range="{{formatOptions}}"
        range-key="label"
        value="{{formatIndex}}"
        bindchange="onFormatChange"
      >
        <view class="picker">
          <text>{{formatOptions[formatIndex].icon}} {{formatOptions[formatIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats" wx:if="{{totalCompressedSize > 0}}">
      <view class="stat-item">
        <text class="stat-label">æ€»è®¡å‹ç¼©:</text>
        <text class="stat-value">{{overallRatio}}%</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">åŸå§‹å¤§å°:</text>
        <text class="stat-value">{{formatSize(totalOriginalSize)}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">å‹ç¼©å:</text>
        <text class="stat-value">{{formatSize(totalCompressedSize)}}</text>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡åˆ—è¡¨ -->
  <view class="images-section" wx:if="{{images.length > 0}}">
    <view class="images-header">
      <text class="images-title">å›¾ç‰‡åˆ—è¡¨</text>
    </view>

    <scroll-view scroll-y class="images-scroll">
      <block wx:for="{{images}}" wx:key="index">
        <view class="image-card">
          <image
            class="preview"
            src="{{item.path}}"
            mode="aspectFill"
          />

          <view class="image-info">
            <view class="size-info">
              <text class="original-size">{{formatSize(item.originalSize)}}</text>
              <text class="arrow" wx:if="{{item.compressedSize}}">â†’</text>
              <text class="compressed-size" wx:if="{{item.compressedSize}}">
                {{formatSize(item.compressedSize)}}
              </text>
            </view>

            <view class="dimension-info">
              <text class="dimension">{{item.width}}Ã—{{item.height}}</text>
            </view>

            <view class="ratio-badge" wx:if="{{item.ratio}}">
              <text class="badge">-{{item.ratio}}%</text>
            </view>
          </view>

          <view class="image-actions">
            <button
              wx:if="{{item.compressedPath}}"
              size="mini"
              class="save-btn"
              bindtap="saveSingleImage"
              data-index="{{index}}"
            >
              ä¿å­˜
            </button>
            <button
              size="mini"
              class="delete-btn"
              bindtap="deleteImage"
              data-index="{{index}}"
            >
              åˆ é™¤
            </button>
          </view>
        </view>
      </block>
    </scroll-view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-emoji">ğŸ–¼ï¸</text>
    <text class="empty-tip">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©å›¾ç‰‡</text>
    <text class="empty-desc">æ”¯æŒä¸€æ¬¡é€‰æ‹©æœ€å¤š9å¼ å›¾ç‰‡</text>
  </view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="bottom-actions" wx:if="{{images.length > 0}}">
    <button
      class="compress-btn"
      bindtap="startCompress"
      disabled="{{isCompressing}}"
      loading="{{isCompressing}}"
    >
      {{isCompressing ? 'å‹ç¼©ä¸­ ' + compressProgress + '%' : 'å¼€å§‹å‹ç¼©'}}
    </button>

    <button
      class="save-all-btn"
      bindtap="saveAllToAlbum"
      disabled="{{totalCompressedSize === 0}}"
    >
      ä¿å­˜å…¨éƒ¨
    </button>
  </view>

</view>
